sudo: required
dist: trusty
language: node_js
node_js:
  - "node"

cache:
  yarn: true
  directories:
    - node_modules

before_install:
 - export CHROME_BIN=/usr/bin/google-chrome
 - export DISPLAY=:99.0
 - sh -e /etc/init.d/xvfb start
 - sudo apt-get update
 - sudo apt-get install -y libappindicator1 fonts-liberation
 - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
 - sudo dpkg -i google-chrome*.deb
 - chmod +x ./scripts/travis-push.sh
 - chmod +x ./scripts/travis.sh

script: ./scripts/travis.sh
#- npm run eslint
#- npm run flow
#- npm run test

stages:
#  - lintAndTest
#  - releaseCanary
  - release
  - deploy
jobs:
  # stage: optional is allowed to be failure
  fast_finish: true
#  allow_failures:
#    - stage: testFuncOptional
  include:
    # https://docs.travis-ci.com/user/build-stages/deploy-github-releases/
    - stage: release
    name: "Releasing a new version"
    if: (branch = master) AND (type = api)
    env: TRAVIS_MODE=release
    - stage: deploy
      name: "Deploying"
      if: (branch = master) AND (tag IS present)
      env: TRAVIS_MODE=deploy
      deploy:
        provider: releases
        api_key:
          secure: $GH_TOKEN
        file_glob: true
        file: dist/*
        draft: true
        skip_cleanup: true
        on:
          tags: true
    # publish canary package if on master
#    - stage: releaseCanary
#      if: branch = master AND type != pull_request
#      env: TRAVIS_MODE=releaseCanary
    # Required tests
    - stage: lintAndTest
      name: "Running lint"
      env:   TRAVIS_MODE=lint
    - stage: lintAndTest
      name: "Running Flow type check"
      env:   TRAVIS_MODE=flow
    - stage: lintAndTest
      name: "Running unit tests"
      env:   TRAVIS_MODE=unitTests
